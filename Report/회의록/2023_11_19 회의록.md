# 2023.11.19 회의록

---

# 각 함수 구현

- **register (회원가입)**
    1. user_id 입력
    2. user_pw 입력
    3. role 입력 (선택)
- **log_in (로그인)**
    1. user_id 입력
    2. user_pw 입력
- **log_out (로그아웃)**
- **view_student_info (원아 정보 불러오기)**
    - 이름
    - 반 이름
    - 생년월일
    - 출석상태
    - 건강상태
    - 주소
- **manage_student_info (원아 정보 관리)**
    - 출석 상태 업데이트
    - 건강 상태 업데이트 (의료기록, 복용중인 약)
    - 주소 업데이트
- **view_chat (알림장 보기)**
    - receiverID인 사람들, Role이 원장, 교사가 보기 가능
    - SenderName, Message, TimeStamp, Image Return
- **insert_chat (알림장 쓰기)**
    - recieverID (Users_StudentID = “?”인 사용자 모두) 인 Student_id 입력
    - Message 입력
    - TimeStamp는 자동 할당
    - image 불러오기/촬영으로 입력
- **set_schedule (스케줄 관리)**
    1. 날짜, 시간 입력
    2. 이벤트 유형 입력
    3. 스케줄 참여 학생 입력
    4. 스케줄 등록
- **view_schedule (스케줄 확인)**
    1. 모든 사람이 보기 가능
    2. 날짜 입력
    3. 날짜, 시간, 이벤트 유형, 스케줄 참여 학생, 스케줄 Return
- **guardian_select (하원주체 선택)**
    1. 원하는 guardian 선택
        - 해당 guardian은 시스템에 등록된 자만 선택 가능
        - ex) 할머니, 할아버지, 형제, 고모, 이모 등. 등록된 사람이 아니면 예외처리
- **post_free_board (자유게시판 글 등록)**
    - title 입력
    - content 입력
    - TimeStamp는 자동 할당
    - image 입력 (입력 없이도 글 등록 가능 NULL 허용)
- **write_post_comment (게시판 글에 댓글 등록)**
    - Comment Content 입력
    - TimeStamp는 자동 할당
- **view_free_board (자유게시판 보기)**
    - title의 list 출력
        - select title from FreeBoardQA;
- **view_post (자유게시판 글 보기)**
    - parameter: postID
    - title 입력 (선택) 시 view_post 함수 call 됨. (GUI)
        - 해당 글의 title, content, timestamp, image Return
        - 해당 글의 Comment의 Content Return
- **update_post (자유게시판 글 수정)**
    - parameter: postId, new_title, new_content, new_image
    - 수정하고자 하는 title, content, image의 정보를 받아 해당 postID와 동일한 게시물의 속성들을 변경한다.
- **update_comment (댓글 수정)**
    - parameter: postId, new_title, new_content, new_image
    - 수정하고자 하는 title, content, image의 정보를 받아 해당 postID와 동일한 게시물의 속성들을 변경한다.
- **delete_post_free_board (자유게시판 글 삭제)**
    - 삭제 선택
        - if (user_id ≠ postid) 예외 처리
        - else post delete
        - comment의 postiD가 같은 것도 모두 delete
- **delete_comment (게시판 글의 댓글 삭제)**
    - 삭제 선택
        - if (user_id ≠ commenter_id) 예외 처리
        - else comment delete
- **register_meal (식단표 등록)**
    - 날짜 선택
    - Meal1, Meal2, Meal3 등록
- **view_todays_meal (오늘의 식단표 열람)**
    - 오늘의 식단 (Meal1, Meal2, Meal3) Return
- **view_other_days_meal (다른날짜의 식단표 열람)**
    - 날짜 선택
    - 해당 날짜의 Meal1, Meal2, Meal3 Return
    - if 해당 날짜의 식단이 NULL 이라면
        - null exception : 아직 등록되지 않은 식단입니다.

# Query CRUD

### FreeBoardQA

- insert
    
    ```python
    def post_free_board (title, content, poster_id, image=None):
        if not con:
            return
    
        try:
            with con, con.cursor() as cursor:
                cursor.execute("""
                    INSERT INTO FreeBoardQA (PosterID, Title, Content, Image, TimeStamp)
                    VALUES (%s, %s, %s, %s, CURRENT_TIMESTAMP)
                    RETURNING PostID;
                """, (poster_id, title, content, image))
    
                post_id = cursor.fetchone()[0]
                return post_id
        except Exception as e:
            print(f"Error: Unable to create post\n{e}")
        finally:
            close(con)
    ```
    
- read
    
    ```python
    def view_post(post_id):
        if not con:
            return
    
        try:
            with con, con.cursor() as cursor:
                cursor.execute("""
                    SELECT * FROM FreeBoardQA
                    WHERE PostID = %s;
                """, (post_id,))
                
                post = cursor.fetchone()
    
                if not post:
                    print("Post not found")
                    return
    
                cursor.execute("""
                    SELECT * FROM Comment
                    WHERE PostID = %s;
                """, (post_id,))
    
                comments = cursor.fetchall()
                
                return post, comments
        except Exception as e:
            print(f"Error: Unable to get post with comments\n{e}")
        finally:
            close(con)
    ```
    
- update
    
    ```python
    def update_post(post_id, new_title, new_content, new_image=None
        if not con:
            return
    
        try:
            with con, con.cursor() as cursor:
                cursor.execute("""
                    UPDATE FreeBoardQA
                    SET Title = %s, Content = %s, Image = %s
                    WHERE PostID = %s;
                """, (new_title, new_content, new_image, post_id))
        except Exception as e:
            print(f"Error: Unable to update post\n{e}")
        finally:
            close(con)
    ```
    
- delete
    
    ```python
    def delete_post_free_board(post_id
        if not con:
            return
    
        try:
            with con, con.cursor() as cursor:
                cursor.execute("""
                    DELETE FROM FreeBoardQA
                    WHERE PostID = %s;
                """, (post_id,))
                print("delete post!")
        except Exception as e:
            print(f"Error: Unable to delete post\n{e}")
        finally:
            close(con)
    ```
    

### Comment

- insert
    
    ```sql
    def write_post_comment(post_id, commenter_id, comment_content)
        if not con:
            return
    
        try:
            with con, con.cursor() as cursor:
                cursor.execute("""
                    INSERT INTO Comment (PostID, CommenterID, CommentContent, TimeStamp)
                    VALUES (%s, %s, %s, CURRENT_TIMESTAMP);
                """, (post_id, commenter_id, comment_content))
        except Exception as e:
            print(f"Error: Unable to create comment\n{e}")
        finally:
            close(con)
    ```
    
- read
    
    ```sql
    -- FreeBoardQA의 read에 함께 구현
    ```
    
- update
    
    ```python
    def update_comment(comment_id, commenter_id, new_content)
        if not con:
            return
    
        try:
            with con, con.cursor() as cursor:
                cursor.execute("""
                    UPDATE Comment
                    SET CommentContent = %s ,CommenterID = %s
                        , TimeStamp = CURRENT_TIMESTAMP
                    WHERE CommentID = %s;
                """, (new_content,  commenter_id, comment_id))
        except Exception as e:
            print(f"Error: Unable to update comment\n{e}")
        finally:
            close(con)
    ```
    
- delete
    
    ```sql
    def delete_comment(comment_id):
        if not con:
            return
        try:
            with con, con.cursor() as cursor:
                cursor.execute("""
                    DELETE FROM Comment
                    WHERE CommentID = %s;
                """, (comment_id,))
                print("delete comment!")
        except Exception as e:
            print(f"Error: Unable to delete comment\n{e}")
        finally:
            close(con)
    ```
    

---

# 기존 table 수정 내역

1. **Comment 테이블 수정**
    - CommenterID 추가함. 해당 forein key도 작성.
    - FreeBoardQA(PostID) ON DELETE CASCADE 추가함

```sql
-- 테이블 삭제
DROP TABLE Comment;

-- Comment(댓글)
CREATE TABLE Comment (
    CommentID SERIAL PRIMARY KEY,
    PostID INTEGER,
    CommenterID INTEGER,  -- 추가된 부분
    CommentContent TEXT,
    TimeStamp TIMESTAMP,
    FOREIGN KEY (PostID) REFERENCES FreeBoardQA(PostID) ON DELETE CASCADE,
    FOREIGN KEY (CommenterID) REFERENCES Users(UserID)  -- 추가된 부분
);
```

```sql
termkk=> \d Comment
                                              Table "public.comment"
     Column     |            Type             | Collation | Nullable |                  Default                   
----------------+-----------------------------+-----------+----------+--------------------------------------------
 commentid      | integer                     |           | not null | nextval('comment_commentid_seq'::regclass)
 postid         | integer                     |           |          | 
 commenterid    | integer                     |           |          | 
 commentcontent | text                        |           |          | 
 timestamp      | timestamp without time zone |           |          | 
Indexes:
    "comment_pkey" PRIMARY KEY, btree (commentid)
Foreign-key constraints:
    "comment_commenterid_fkey" FOREIGN KEY (commenterid) REFERENCES users(userid)
    "comment_postid_fkey" FOREIGN KEY (postid) REFERENCES freeboardqa(postid) ON DELETE CASCADE
```

1. **GuardianSelection 테이블 수정**
    - teacherID는 받아올 필요가 없으므로 삭제함.

```sql
-- 테이블 삭제
DROP TABLE GuardianSelection;

-- 수정된 테이블
CREATE TABLE GuardianSelection (
    SelectionID SERIAL PRIMARY KEY,
    GuardianID INTEGER,
    StudentID INTEGER,
    FOREIGN KEY (GuardianID) REFERENCES Users(UserID),
    FOREIGN KEY (StudentID) REFERENCES Student(StudentID)
);
```

```sql
termkk=> \d GuardianSelection
                                   Table "public.guardianselection"
   Column    |  Type   | Collation | Nullable |                        Default                         
-------------+---------+-----------+----------+--------------------------------------------------------
 selectionid | integer |           | not null | nextval('guardianselection_selectionid_seq'::regclass)
 guardianid  | integer |           |          | 
 studentid   | integer |           |          | 
Indexes:
    "guardianselection_pkey" PRIMARY KEY, btree (selectionid)
Foreign-key constraints:
    "guardianselection_guardianid_fkey" FOREIGN KEY (guardianid) REFERENCES users(userid)
    "guardianselection_studentid_fkey" FOREIGN KEY (studentid) REFERENCES student(studentid)
```

1. **Users 테이블에 UserPassWord Column 추가**

```sql
ALTER TABLE Users
ADD COLUMN UserPassword VARCHAR(255); -- Adjust the length as needed
```

- 이미 넣은 dummy datas에 각 password도 추가해야 한다.

```sql
-- Update passwords for existing users
UPDATE Users SET UserPassword = '123^' WHERE UserID = 1;
UPDATE Users SET UserPassword = '234!' WHERE UserID = 2;
UPDATE Users SET UserPassword = '345/' WHERE UserID = 3;
```

- 실행 결과

```sql
termkk=> select * from Users;
 userid | username  | userrole | studentid | userpassword 
--------+-----------+----------+-----------+--------------
      1 | teacher1  | Teacher  |         1 | 123^
      2 | guardian1 | Guardian |         2 | 234!
      3 | guardian2 | Guardian |         3 | 345/
(3 rows)
```

1. **기존 Role에 영어 이름 추가**
    1. 원장 (Principal)
    2. 교사 (Teacher)
    3. 원아 (Student - 원아는 일반적으로 어린 아이들을 지칭하는 말이므로, '학생'보다는 'Student'가 더 적합할 수 있습니다. 'Pupil'은 더 고전적인 용어이지만 여전히 사용되기도 합니다.)
    4. 돌봄주체 (Guardian)
    5. 기타 교직원 (OtherSchoolStaff)
    6. 원아 가족 (Student's Family)

```sql
-- 1. 새로운 enum type 정의
CREATE TYPE role_enum AS ENUM (
    'Principal',
    'Teacher',
    'Student',
    'Guardian',
    'OtherSchoolStaff',
    'StudentsFamily'
);

-- 2. Users 테이블의 userrole 열을 새로운 enum 타입으로 변경
ALTER TABLE Users
ALTER COLUMN userrole TYPE role_enum
USING userrole::role_enum;

-- 3. userrole 열에 대한 체크 제약 조건을 추가
ALTER TABLE Users
ADD CONSTRAINT valid_userrole CHECK (userrole IN ('Principal', 'Teacher', 'Student', 'Guardian', 'OtherSchoolStaff', 'StudentsFamily'));

-- 4. 기존 데이터 업데이트
UPDATE Users
SET userrole = 'Principal'
WHERE userrole = 'Principal';

UPDATE Users
SET userrole = 'Teacher'
WHERE userrole = 'Teacher';

UPDATE Users
SET userrole = 'Student'
WHERE userrole = 'Student';

UPDATE Users
SET userrole = 'Guardian'
WHERE userrole = 'Guardian';

UPDATE Users
SET userrole = 'OtherSchoolStaff'
WHERE userrole = 'OtherSchoolStaff';

UPDATE Users
SET userrole = 'StudentsFamily'
WHERE userrole = 'StudentsFamily';
```

```sql
termkk=> \d Users;
                                         Table "public.users"
    Column    |          Type          | Collation | Nullable |                Default                
--------------+------------------------+-----------+----------+---------------------------------------
 userid       | integer                |           | not null | nextval('users_userid_seq'::regclass)
 username     | character varying(20)  |           |          | 
 userrole     | role_enum              |           |          | 
 studentid    | integer                |           |          | 
 userpassword | character varying(255) |           |          | 
Indexes:
    "users_pkey" PRIMARY KEY, btree (userid)
Check constraints: -- enum type이 맞는지 확인함.
    "valid_userrole" CHECK (userrole = ANY (ARRAY['Principal'::role_enum, 'Teacher'::role_enum, 'Student'::role_enum, 'Guardian'::role_enum, 'OtherSchoolStaff'::role_enum, 'StudentsFamily'::role_enum]))
Foreign-key constraints:
    "users_studentid_fkey" FOREIGN KEY (studentid) REFERENCES student(studentid)
Referenced by:
    TABLE "comment" CONSTRAINT "comment_commenterid_fkey" FOREIGN KEY (commenterid) REFERENCES users(userid)
    TABLE "freeboardqa" CONSTRAINT "freeboardqa_posterid_fkey" FOREIGN KEY (posterid) REFERENCES users(userid)
    TABLE "guardianselection" CONSTRAINT "guardianselection_guardianid_fkey" FOREIGN KEY (guardianid) REFERENCES users(userid)
```

---

# 구현한 함수 main.py

```python
# Version.1

import psycopg2
from datetime import datetime

# Connect to Database
def connect_to_database():
    con = psycopg2.connect(
        database='termkk',
        user='db2023',
        password='db!2023',
        host='::1',
        port='5432'
    )
    conn = con.cursor()
    return con, conn

# 사용자 등록
def register(con, conn, user_name, user_pw, user_role, student_id):
    try:
        # Check if the provided user_role is valid
        valid_roles = ['Principal', 'Teacher', 'Student', 'Guardian', 'OtherSchoolStaff', 'StudentsFamily']
        if user_role not in valid_roles:
            raise ValueError(f"Invalid user_role: {user_role}. Allowed roles are {', '.join(valid_roles)}.")

        # Check if the provided student_id exists in the Student table
        query_check_student = "SELECT studentid FROM Student WHERE StudentID = %s;"
        conn.execute(query_check_student, (student_id,))
        if conn.fetchone() is None:
            raise ValueError(f"Student with ID {student_id} does not exist. Please provide a valid student ID.")

        # Continue with the registration if the user_role and student_id are valid
        query_user = "INSERT INTO Users (UserName, UserRole, StudentID, UserPassword) VALUES (%s, %s, %s, %s) RETURNING UserID;"
        conn.execute(query_user, (user_name, user_role, student_id, user_pw))
        user_id = conn.fetchone()[0]

        query_student = "INSERT INTO Student (StudentID) VALUES (%s);"
        conn.execute(query_student, (user_id,))

        con.commit()
        return f"User {user_id} registered successfully."
    except Exception as e:
        con.rollback()
        return f"Error: {e}"

# 로그인
def log_in(con, conn, user_id, user_pw):
    try:
        query = "SELECT UserID FROM Users WHERE UserName = %s AND UserPassword = %s;"
        conn.execute(query, (user_id, user_pw))
        result = conn.fetchone()
        if result:
            return f"Login successful. UserID: {result[0]}"
        else:
            return "Login failed. Invalid credentials."
    except Exception as e:
        return f"Error: {e}"

# 로그아웃
def log_out(con, conn):
    con.close()
    return "Logout successful."

# 원아 정보 조회
def view_student_info(conn, user_id):
    try:
        query = "SELECT * FROM Student WHERE StudentID = (SELECT StudentID FROM Users WHERE UserID = %s);"
        conn.execute(query, (user_id,))
        result = conn.fetchone()
        return result
    except Exception as e:
        return f"Error: {e}"

# 원아 정보 관리
def manage_student_info(con, conn, user_id, attendance, health_status, address):
    try:
        query = "UPDATE Student SET Attendance = %s, HealthStatus = %s, Address = %s WHERE StudentID = (SELECT StudentID FROM Users WHERE UserID = %s);"
        conn.execute(query, (attendance, health_status, address, user_id))
        con.commit()
        return "Student information updated successfully."
    except Exception as e:
        con.rollback()
        return f"Error: {e}"

# 알림장 조회
def view_chat(con, conn, receiver_id, user_role):
    try:
        if user_role in ["Principal", "Teacher"]:
            query = "SELECT SenderID, Message, TimeStamp, Image FROM Chat WHERE ReceiverID = %s;"
            conn.execute(query, (receiver_id,))
            result = conn.fetchall()
            return result
        else:
            return "Unauthorized. Only Principal and Teacher can view chat messages."
    except Exception as e:
        return f"Error: {e}"

# 알림장 작성
def insert_chat(con, conn, user_id, receiver_id, message, image):
    try:
        sender_id =  user_id
        query = "INSERT INTO Chat (SenderID, ReceiverID, Message, TimeStamp, Image) VALUES (%s, %s, %s, %s, %s);"
        conn.execute(query, (sender_id, receiver_id, message, datetime.now(), image))
        con.commit()
        return "Chat message added successfully."
    except Exception as e:
        con.rollback()
        return f"Error: {e}"

# 스케줄 등록
def set_schedule(con, conn, date, time, event_type, student_ids):
    try:
        query = "INSERT INTO Schedule (EventType, Date, Time) VALUES (%s, %s, %s) RETURNING ScheduleID;"
        conn.execute(query, (event_type, date, time))
        schedule_id = conn.fetchone()[0]

        for student_id in student_ids:
            query = "INSERT INTO ScheduleStudent (ScheduleID, StudentID) VALUES (%s, %s);"
            conn.execute(query, (schedule_id, student_id))

        con.commit()
        return f"Schedule added successfully. ScheduleID: {schedule_id}"
    except Exception as e:
        con.rollback()
        return f"Error: {e}"

# 스케줄 조회
def view_schedule(con, conn, date=None):
    try:
        if date:
            query = "SELECT EventType, Date, Time FROM Schedule WHERE Date = %s;"
            conn.execute(query, (date,))
        else:
            query = "SELECT EventType, Date, Time FROM Schedule;"
            conn.execute(query)
        
        result = conn.fetchall()
        return result
    except Exception as e:
        return f"Error: {e}"

# 하원 주체 선택
def guardian_select(con, conn, user_id, guardian_id):
    try:
        # 현재 로그인한 사용자의 StudentID를 가져오는 코드
        query1 = "SELECT StudentID FROM Users WHERE UserID = %s;"
        conn.execute(query1, (user_id,))
        result = conn.fetchone()
        if result is None:
            raise Exception("Student not found.")

        student_id = result[0]

        # GuardianSelection에 데이터 추가
        query2 = "INSERT INTO GuardianSelection (GuardianID, StudentID) VALUES (%s, %s);"
        conn.execute(query2, (guardian_id, student_id))
        con.commit()
        return "Guardian selection successful."
    except Exception as e:
        con.rollback()
        return f"Error: {e}"

# 자유게시판 글 등록

def post_free_board (con, title, content, poster_id, image=None):
    try:
        with con, con.cursor() as cursor:
            cursor.execute("""
                INSERT INTO FreeBoardQA (PosterID, Title, Content, Image, TimeStamp)
                VALUES (%s, %s, %s, %s, CURRENT_TIMESTAMP)
                RETURNING PostID;
            """, (poster_id, title, content, image))

            post_id = cursor.fetchone()[0]
            return post_id
    except Exception as e:
        print(f"Error: Unable to create post\n{e}")
    finally:
        close(con)

# 게시판 글에 댓글 등록 함수
def write_post_comment(con, conn, post_id, commenter_id, comment_content):
    try:
        query = "INSERT INTO Comment (PostID, CommenterID, CommentContent, TimeStamp) VALUES (%s, %s, %s, %s);"
        conn.execute(query, (post_id, commenter_id, comment_content, datetime.now()))
        con.commit()
        return "Comment added successfully."
    except Exception as e:
        con.rollback()
        return f"Error: {e}"

# 자유게시판 보기 함수
def view_free_board(con, conn):
    try:
        query = "SELECT PostID, Title FROM FreeBoardQA;"
        conn.execute(query)
        result = conn.fetchall()
        return result
    except Exception as e:
        return f"Error: {e}"

# 자유게시판 글 보기 함수
def view_post(con, conn, post_id):
    try:
        query = "SELECT Title, Content, TimeStamp, Image FROM FreeBoardQA WHERE PostID = %s;"
        conn.execute(query, (post_id,))
        post_info = conn.fetchone()

        query = "SELECT CommentContent FROM Comment WHERE PostID = %s;"
        conn.execute(query, (post_id,))
        comments = conn.fetchall()

        return {"post_info": post_info, "comments": comments}
    except Exception as e:
        return f"Error: {e}"

# 자유게시판 글 삭제 함수
def delete_post_free_board(con, conn, post_id, user_id):
    try:
        # user_id와 post_id가 일치하는지 확인
        query = "SELECT PosterID FROM FreeBoardQA WHERE PostID = %s;"
        conn.execute(query, (post_id,))
        poster_id = conn.fetchone()

        if poster_id and poster_id[0] == user_id:
            # 게시글 삭제
            query = "DELETE FROM FreeBoardQA WHERE PostID = %s;"
            conn.execute(query, (post_id,))

            # 게시글에 속한 댓글 삭제
            query = "DELETE FROM Comment WHERE PostID = %s;"
            conn.execute(query, (post_id,))

            con.commit()
            return "Post deleted successfully."
        else:
            return "Unauthorized. You cannot delete this post."
    except Exception as e:
        con.rollback()
        return f"Error: {e}"

# 게시판 글의 댓글 삭제 함수
def delete_comment(con, conn, comment_id, user_id):
    try:
        # user_id와 comment_id가 일치하는지 확인
        query = "SELECT CommenterID FROM Comment WHERE CommentID = %s;"
        conn.execute(query, (comment_id,))
        commenter_id = conn.fetchone()

        if commenter_id and commenter_id[0] == user_id:
            # 댓글 삭제
            query = "DELETE FROM Comment WHERE CommentID = %s;"
            conn.execute(query, (comment_id,))
            con.commit()
            return "Comment deleted successfully."
        else:
            return "Unauthorized. You cannot delete this comment."
    except Exception as e:
        con.rollback()
        return f"Error: {e}"

# 식단표 등록 함수
def register_meal(con, conn, date, meal1, meal2, snack):
    try:
        # Check if the meal plan for the given date already exists
        query_check = "SELECT * FROM MealPlan WHERE Date = %s;"
        conn.execute(query_check, (date,))
        result_check = conn.fetchone()

        if result_check:
            # If meal plan for the given date exists, update the existing record
            query_update = "UPDATE MealPlan SET Meal1 = %s, Meal2 = %s, Snack = %s WHERE Date = %s;"
            conn.execute(query_update, (meal1, meal2, snack, date))
            con.commit()
            return "Meal plan updated successfully."
        else:
            # If meal plan for the given date does not exist, insert a new record
            query_insert = "INSERT INTO MealPlan (Date, Meal1, Meal2, Snack) VALUES (%s, %s, %s, %s);"
            conn.execute(query_insert, (date, meal1, meal2, snack))
            con.commit()
            return "Meal plan registered successfully."

    except Exception as e:
        con.rollback()
        return f"Error: {e}"

# 오늘의 식단 열람 함수
def view_todays_meal(con, conn):
    try:
        today = datetime.now().date()
        query = "SELECT Meal1, Meal2, Snack FROM MealPlan WHERE Date = %s;"
        conn.execute(query, (today,))
        result = conn.fetchone()
        return result
    except Exception as e:
        return f"Error: {e}"

# 다른 날짜의 식단 열람 함수
def view_other_days_meal(con, conn, date):
    try:
        query = "SELECT Meal1, Meal2, Snack FROM MealPlan WHERE Date = %s;"
        conn.execute(query, (date,))
        result = conn.fetchone()
        return result
    except Exception as e:
        return f"Error: {e}"

def main():
    con, conn = connect_to_database()
    
    try:
        print("\n==========[Example of using the register function]==========")
        wanna_register = input("Enter if you want to register(y/n): ")
        if (wanna_register):
            user_name = input("Enter username: ")
            user_pw = input("Enter password: ")
            user_role = input("Enter user role (Principal/Teacher/Student/Guardian/OtherSchoolStaff/StudentsFamily): ")
            student_id = int(input("Enter student ID: "))

            registration_result = register(con, conn, user_name, user_pw, user_role, student_id)
            print(registration_result)

        print("\n==========[Example of using the log_in function]==========")
        user_id = input("Enter your username: ")
        user_pw = input("Enter your password: ")

        logged_in_user_id = log_in(con, conn, user_id, user_pw)
        print(logged_in_user_id)

        if logged_in_user_id.startswith("Login successful"):
            
            print("\n==========[Example of using the view_student_info function]==========")
            student_info = view_student_info(conn, int(logged_in_user_id.split(": ")[1]))
            print("Student Information:")
            print(student_info)

            print("\n==========[Example of using the manage_student_info function]==========")
            attendance = input("Enter attendance (e.g., 1 for present, 0 for absent): ")
            health_status = input("Enter health status: ")
            address = input("Enter address: ")
            manage_student_info(con, conn, int(logged_in_user_id.split(": ")[1]), attendance, health_status, address)
            print("Student information updated successfully.")

            print("\n==========[Example of using the view_chat function]==========")
            receiver_id = int(input("Enter receiver ID: "))
            user_role = "Principal"  # Assuming the logged-in user is the Principal for testing
            chat_messages = view_chat(con, conn, receiver_id, user_role)
            print("Chat Messages:")
            print(chat_messages)

            print("\n==========[Example of using the insert_chat function]==========")
            receiver_id = int(input("Enter receiver ID for chat message: "))
            message = input("Enter chat message: ")
            image = None  # You can add image handling later
            insert_chat(con, conn, int(logged_in_user_id.split(": ")[1]), receiver_id, message, image)
            print("Chat message added successfully.")

            print("\n==========[Example of using the set_schedule function]==========")
            date = input("Enter date for schedule (YYYY-MM-DD): ")
            time = input("Enter time for schedule (HH:MM:SS): ")
            event_type = input("Enter event type: ")
            student_ids_str = input("Enter student IDs for the schedule (comma-separated): ")
            student_ids = [int(student_id) for student_id in student_ids_str.split(",")]
            schedule_result = set_schedule(con, conn, date, time, event_type, student_ids)
            print(schedule_result)

            print("\n==========[Example of using the guardian_select function]==========")
            guardian_id = int(input("Enter Guardian ID for selection: "))
            guardian_select_result = guardian_select(con, conn, int(logged_in_user_id.split(": ")[1]), guardian_id)
            print(guardian_select_result)

            print("\n==========[Example of using the post_free_board function]==========")
            title = input("Enter post title: ")
            content = input("Enter post content: ")
            image = None  # You can add image handling later
            #(con, title, content, poster_id, image=None)
            post_result = post_free_board(con,  title, content, int(logged_in_user_id.split(": ")[1]), image)
            print(post_result)
            
            print("\n==========[Example of using the write_post_comment function]==========")
            post_id = int(input("Enter Post ID for comment: "))
            comment_content = input("Enter comment content: ")
            commenter_id = int(input("Enter Your ID: "))
            comment_result = write_post_comment(con, conn, post_id, commenter_id, comment_content)
            print(comment_result)

            print("\n==========[Example of using the view_free_board function]==========")
            free_board_result = view_free_board(con, conn)
            print("Free Board Posts:")
            print(free_board_result)

            print("\n==========[Example of using the view_post function]==========")
            view_post_id = int(input("Enter Post ID to view details: "))
            view_post_result = view_post(con, conn, view_post_id)
            print("Post Details:")
            print(view_post_result)

            print("\n==========[Example of using the delete_post_free_board function]==========")
            delete_post_id = int(input("Enter Post ID to delete: "))
            delete_post_result = delete_post_free_board(con, conn, delete_post_id, int(logged_in_user_id.split(": ")[1]))
            print(delete_post_result)

            print("\n==========[Example of using the delete_comment function]==========")
            delete_comment_id = int(input("Enter Comment ID to delete: "))
            delete_comment_result = delete_comment(con, conn, delete_comment_id, int(logged_in_user_id.split(": ")[1]))
            print(delete_comment_result)
            
            print("\n==========[Example of using the register_meal function]==========")
            date = input("Enter date for meal registration (YYYY-MM-DD): ")
            meal1 = input("Enter meal 1: ")
            meal2 = input("Enter meal 2: ")
            snack = input("Enter snack: ")
            register_meal_result = register_meal(con, conn, date, meal1, meal2, snack)
            print(register_meal_result)

            print("\n==========[Example of using the view_todays_meal function]==========")
            view_todays_meal_result = view_todays_meal(con, conn)
            print("Today's Meal:")
            print(view_todays_meal_result)

            print("\n==========[Example of using the view_other_days_meal function]==========")
            view_other_date = input("Enter date to view meal (YYYY-MM-DD): ")
            view_other_days_meal_result = view_other_days_meal(con, conn, view_other_date)
            print("Meal for the specified date:")
            print(view_other_days_meal_result)

        # 로그아웃
        log_out(con, conn)
        print("Logout successful.")

    finally:
        # Close cursor and connection if they are still open
        if conn is not None and not conn.closed:
            conn.close()
        if con is not None and not con.closed:
            con.close()

if __name__ == '__main__':
    main()
```

---

```python
# Version.2

import psycopg2
from datetime import datetime

# Connect to Database
def connect_to_database():
    con = psycopg2.connect(
        database='termkk',
        user='db2023',
        password='db!2023',
        host='::1',
        port='5432'
    )
    conn = con.cursor()
    return con, conn

# 사용자 등록
def register(con, conn, user_id, user_pw, role):
    try:
        query = "INSERT INTO Users (UserName, UserRole) VALUES (%s, %s) RETURNING UserID;"
        conn.execute(query, (user_id, role))
        user_id = conn.fetchone()[0]

        query = "INSERT INTO Student (StudentID) VALUES (%s);"
        conn.execute(query, (user_id,))

        query = "INSERT INTO MealPlan (Date) VALUES (%s);"
        conn.execute(query, (datetime.now().date(),))

        con.commit()
        return f"User {user_id} registered successfully."
    except Exception as e:
        con.rollback()
        return f"Error: {e}"
    finally:
        con.close()

 # 로그인
def log_in(con, conn, user_id, user_pw):
    try:
        query = "SELECT UserID FROM Users WHERE UserName = %s AND UserPassword = %s;"
        conn.execute(query, (user_id, user_pw))
        result = conn.fetchone()
        if result:
            return f"Login successful. UserID: {result[0]}"
        else:
            return "Login failed. Invalid credentials."
    except Exception as e:
        return f"Error: {e}"

# 로그아웃
def log_out(con, conn):
    con.close()
    return "Logout successful."

# 원아 정보 조회
def view_student_info(conn, user_id):
    try:
        query = "SELECT * FROM Student WHERE StudentID = (SELECT StudentID FROM Users WHERE UserID = %s);"
        conn.execute(query, (user_id,))
        result = conn.fetchone()
        return result
    except Exception as e:
        return f"Error: {e}"

# 원아 정보 관리
def manage_student_info(con, conn, user_id, attendance, health_status, address):
    try:
        query = "UPDATE Student SET Attendance = %s, HealthStatus = %s, Address = %s WHERE StudentID = (SELECT StudentID FROM Users WHERE UserID = %s);"
        conn.execute(query, (attendance, health_status, address, user_id))
        con.commit()
        return "Student information updated successfully."
    except Exception as e:
        con.rollback()
        return f"Error: {e}"

# 알림장 조회
def view_chat(con, conn, receiver_id, user_role):
    try:
        if user_role in ["Principal", "Teacher"]:
            query = "SELECT SenderID, Message, TimeStamp, Image FROM Chat WHERE ReceiverID = %s;"
            conn.execute(query, (receiver_id,))
            result = conn.fetchall()
            return result
        else:
            return "Unauthorized. Only Principal and Teacher can view chat messages."
    except Exception as e:
        return f"Error: {e}"

# 알림장 작성
def insert_chat(con, conn, user_id, receiver_id, message, image):
    try:
        sender_id =  user_id
        query = "INSERT INTO Chat (SenderID, ReceiverID, Message, TimeStamp, Image) VALUES (%s, %s, %s, %s, %s);"
        conn.execute(query, (sender_id, receiver_id, message, datetime.now(), image))
        con.commit()
        return "Chat message added successfully."
    except Exception as e:
        con.rollback()
        return f"Error: {e}"

# 스케줄 등록
def set_schedule(con, conn, date, time, event_type, student_ids):
    try:
        query = "INSERT INTO Schedule (EventType, Date, Time) VALUES (%s, %s, %s) RETURNING ScheduleID;"
        conn.execute(query, (event_type, date, time))
        schedule_id = conn.fetchone()[0]

        for student_id in student_ids:
            query = "INSERT INTO ScheduleStudent (ScheduleID, StudentID) VALUES (%s, %s);"
            conn.execute(query, (schedule_id, student_id))

        con.commit()
        return f"Schedule added successfully. ScheduleID: {schedule_id}"
    except Exception as e:
        con.rollback()
        return f"Error: {e}"

# 스케줄 조회
def view_schedule(con, conn, date=None):
    try:
        if date:
            query = "SELECT EventType, Date, Time FROM Schedule WHERE Date = %s;"
            conn.execute(query, (date,))
        else:
            query = "SELECT EventType, Date, Time FROM Schedule;"
            conn.execute(query)
        
        result = conn.fetchall()
        return result
    except Exception as e:
        return f"Error: {e}"

# 하원 주체 선택
def guardian_select(con, conn, user_id, guardian_id):
    try:
        # 현재 로그인한 사용자의 StudentID를 가져오는 코드
        query1 = "SELECT StudentID FROM Users WHERE UserID = %s;"
        conn.execute(query1, (user_id,))
        result = conn.fetchone()
        if result is None:
            raise Exception("Student not found.")

        student_id = result[0]

        # GuardianSelection에 데이터 추가
        query2 = "INSERT INTO GuardianSelection (GuardianID, StudentID) VALUES (%s, %s);"
        conn.execute(query2, (guardian_id, student_id))
        con.commit()
        return "Guardian selection successful."
    except Exception as e:
        con.rollback()
        return f"Error: {e}"

# 자유게시판 글 등록
def post_free_board (title, content, poster_id, image=None):
    if not con:
        return
    try:
        with con, con.cursor() as cursor:
            cursor.execute("""
                INSERT INTO FreeBoardQA (PosterID, Title, Content, Image, TimeStamp)
                VALUES (%s, %s, %s, %s, CURRENT_TIMESTAMP)
                RETURNING PostID;
            """, (poster_id, title, content, image))

            post_id = cursor.fetchone()[0]
            return post_id
    except Exception as e:
        print(f"Error: Unable to create post\n{e}")
    finally:
        close(con)

# 게시판 글에 댓글 등록 함수
def write_post_comment(post_id, commenter_id, comment_content)
    if not con:
        return

    try:
        with con, con.cursor() as cursor:
            cursor.execute("""
                INSERT INTO Comment (PostID, CommenterID, CommentContent, TimeStamp)
                VALUES (%s, %s, %s, CURRENT_TIMESTAMP);
            """, (post_id, commenter_id, comment_content))
    except Exception as e:
        print(f"Error: Unable to create comment\n{e}")
    finally:
        close(con)

# 자유게시판 보기 함수
def view_free_board(con, conn):
    try:
        query = "SELECT PostID, Title FROM FreeBoardQA;"
        conn.execute(query)
        result = conn.fetchall()
        return result
    except Exception as e:
        return f"Error: {e}"

# 자유게시판 글 보기 함수
def view_post(post_id):
    if not con:
        return

    try:
        with con, con.cursor() as cursor:
            cursor.execute("""
                SELECT * FROM FreeBoardQA
                WHERE PostID = %s;
            """, (post_id,))
            
            post = cursor.fetchone()

            if not post:
                print("Post not found")
                return

            cursor.execute("""
                SELECT * FROM Comment
                WHERE PostID = %s;
            """, (post_id,))

            comments = cursor.fetchall()
            
            return post, comments
    except Exception as e:
        print(f"Error: Unable to get post with comments\n{e}")
    finally:
        close(con)

# 자유게시판 글 삭제 함수
def delete_post_free_board(con, conn, post_id, user_id):
    try:
        # user_id와 post_id가 일치하는지 확인
        query = "SELECT PosterID FROM FreeBoardQA WHERE PostID = %s;"
        conn.execute(query, (post_id,))
        poster_id = conn.fetchone()

        if poster_id and poster_id[0] == user_id:
            # 게시글 삭제
            query = "DELETE FROM FreeBoardQA WHERE PostID = %s;"
            conn.execute(query, (post_id,))

            # 게시글에 속한 댓글 삭제
            query = "DELETE FROM Comment WHERE PostID = %s;"
            conn.execute(query, (post_id,))

            con.commit()
            return "Post deleted successfully."
        else:
            return "Unauthorized. You cannot delete this post."
    except Exception as e:
        con.rollback()
        return f"Error: {e}"

# 게시판 글의 댓글 삭제 함수
def delete_comment(comment_id):
   # con = connect()
    if not con:
        return

    try:
        with con, con.cursor() as cursor:
            cursor.execute("""
                DELETE FROM Comment
                WHERE CommentID = %s;
            """, (comment_id,))
            print("delete comment!")
    except Exception as e:
        print(f"Error: Unable to delete comment\n{e}")
    finally:
        close(con)

# 게시판 게시물의 수정 함수
def update_post(post_id, new_title, new_content, new_image=None):
		if not con:
        return

    try:
        with con, con.cursor() as cursor:
            cursor.execute("""
                UPDATE FreeBoardQA
                SET Title = %s, Content = %s, Image = %s
                WHERE PostID = %s;
            """, (new_title, new_content, new_image, post_id))
    except Exception as e:
        print(f"Error: Unable to update post\n{e}")
    finally:
        close(con)

# 게시판 댓글 수정 함수
def update_comment(comment_id, commenter_id, new_content):
    if not con:
        return

    try:
        with con, con.cursor() as cursor:
            cursor.execute("""
                UPDATE Comment
                SET CommentContent = %s ,CommenterID = %s
                    , TimeStamp = CURRENT_TIMESTAMP
                WHERE CommentID = %s;
            """, (new_content,  commenter_id, comment_id))
    except Exception as e:
        print(f"Error: Unable to update comment\n{e}")
    finally:
        close(con)

# 식단표 등록 함수
def register_meal(con, conn, date, meal1, meal2, snack):
    try:
        query = "UPDATE MealPlan SET Meal1 = %s, Meal2 = %s, Snack = %s WHERE Date = %s;"
        conn.execute(query, (meal1, meal2, snack, date))
        con.commit()
        return "Meal plan registered successfully."
    except Exception as e:
        con.rollback()
        return f"Error: {e}"

# 오늘의 식단 열람 함수
def view_todays_meal(con, conn):
    try:
        today = datetime.now().date()
        query = "SELECT Meal1, Meal2, Snack FROM MealPlan WHERE Date = %s;"
        conn.execute(query, (today,))
        result = conn.fetchone()
        return result
    except Exception as e:
        return f"Error: {e}"

# 다른 날짜의 식단 열람 함수
def view_other_days_meal(con, conn, date):
    try:
        query = "SELECT Meal1, Meal2, Snack FROM MealPlan WHERE Date = %s;"
        conn.execute(query, (date,))
        result = conn.fetchone()
        return result
    except Exception as e:
        return f"Error: {e}"

def main():
    con, conn = connect_to_database()
    
    try:
        # 로그인
        user_id = input("Enter your username: ")
        user_pw = input("Enter your password: ")

        logged_in_user_id = log_in(con, conn, user_id, user_pw)
        print(logged_in_user_id)

        if logged_in_user_id.startswith("Login successful"):
            print("\n==========[Example of using the view_student_info function]==========")
            student_info = view_student_info(conn, int(logged_in_user_id.split(": ")[1]))
            print("Student Information:")
            print(student_info)

            print("\n==========[Example of using the manage_student_info function]==========")
            attendance = input("Enter attendance (e.g., 1 for present, 0 for absent): ")
            health_status = input("Enter health status: ")
            address = input("Enter address: ")
            manage_student_info(con, conn, int(logged_in_user_id.split(": ")[1]), attendance, health_status, address)
            print("Student information updated successfully.")

            print("\n==========[Example of using the view_chat function]==========")
            receiver_id = int(input("Enter receiver ID: "))
            user_role = "Principal"  # Assuming the logged-in user is the Principal for testing
            chat_messages = view_chat(con, conn, receiver_id, user_role)
            print("Chat Messages:")
            print(chat_messages)

            print("\n==========[Example of using the insert_chat function]==========")
            receiver_id = int(input("Enter receiver ID for chat message: "))
            message = input("Enter chat message: ")
            image = None  # You can add image handling later
            insert_chat(con, conn, int(logged_in_user_id.split(": ")[1]), receiver_id, message, image)
            print("Chat message added successfully.")

            print("\n==========[Example of using the set_schedule function]==========")
            date = input("Enter date for schedule (YYYY-MM-DD): ")
            time = input("Enter time for schedule (HH:MM:SS): ")
            event_type = input("Enter event type: ")
            student_ids_str = input("Enter student IDs for the schedule (comma-separated): ")
            student_ids = [int(student_id) for student_id in student_ids_str.split(",")]
            schedule_result = set_schedule(con, conn, date, time, event_type, student_ids)
            print(schedule_result)

        # 로그아웃
        log_out(con, conn)
        print("Logout successful.")

    finally:
        # Close cursor and connection if they are still open
        if conn is not None and not conn.closed:
            conn.close()
        if con is not None and not con.closed:
            con.close()

if __name__ == '__main__':
    main()
```

---